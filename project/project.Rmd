---
title: "PROJECT TITLE"
author: "Zuck(R)berg"
date: "25 April 2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Your project goes here! Before you submit, make sure your chunks are turned off with `echo = FALSE`. 

You can add sections as you see fit. Make sure you have a section called Introduction at the beginning and a section called Conclusion at the end. The rest is up to you!

### Introduction

The movie industry is one that accounts for billions of dollars in revenue and forms the keystone of the entertainment sector; consequently, there are a wide variety of films that have had varying degrees of success in the market. There are a variety of characteristics and factors that make up a movie – budget, director, etc. – yet none of these factors alone seem to have the power to drive a successful film. Rather, a combination of positive factors must be achieved to dominate the market. In this project, we will be attempting to address the research question of what specific factors have the most effect in predicting the profitability of a film. 

### Stuff

```{r load-data, message=FALSE}
library(tidyverse)
library(dplyr)
library(broom)
library(stringr)
library(infer)

set.seed(5000)

movies <- read_csv("/cloud/project/data/tmdb_5000_movies.csv")
movies <- movies %>%
  select(-id, -homepage, -original_title)
movies <- movies %>%
  filter(original_language == "en")
movies <- movies %>%
  filter(budget > 0) %>%
  filter(revenue > 0)

```

For our dataset of 5000 movies, we decided to remove the variables id, homepage, and original_title, since we felt that these variables did not contribute to our research question of what contributed to a "successful" movie. Additionally, since we found problems with the budget and revenue variables of non-American movies (not in US dollars), we decided to filter for only english movies as a proxy for American movies. (Since there is no definite way to filter for only American movies). 
We also filtered for movies that had a budget and revenue that were nonzero, this is so that our data would not be skewed by movies that were not intended to draw revenue or were not of the same budget caliber of the rest of the films. 

```{r popularity-explanations}
ggplot(data = movies, aes(y = popularity)) +
  geom_boxplot()

movies %>%
  select(title, popularity) %>%
  arrange(desc(popularity)) %>%
  head(10)
```

We are going to not look at popularity because we can't figure out where this came from,,, etc explain this.

```{r high-budget-list}
movies %>%
  select(title, budget) %>%
  arrange(desc(budget)) %>%
  head(10)
movies %>%
  distinct(production_companies)
```

### Creating a "Profitability" Variables

The first profitability variable is a ratio of revenue to budget, to show by what percentage a movie was "profitable."
This second profitability variable is a categorical variable that deciphers if the movie was profitable or not, based on the profitiability ratio. If the ratio was greater than 1, it was considered profitable. It will simply say "yes" for profitable, and "no" for non-profitable.

```{r}
movies <- movies %>% 
  mutate(pratio = revenue/budget) 
movies <- movies %>%
  mutate(profit = case_when(
    pratio > 1 ~ "yes",
    pratio <= 1 ~ "no"
  )
  )
movies <- movies %>%
  filter(pratio <= 200)

```

To find the 95% confidence interval of pratio:

```{r}
set.seed(5000)
boot_dist <- movies %>%
  specify(response = "pratio") %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "median")

boot_dist %>%
  summarise(
    lower = quantile(stat, 0.025),
    uppper = quantile(stat, 0.975)
  )
```

Insert narrative about confidence interval:

### Making a Categorical "spoken languages" Variable 

Here, we will be creating a new vategorical variable, that signifies if the only language spoken in the film is english, or not. If the only spoken language is english, the value will be "yes," if there are other languages spoken or english is not used, the value will be "no."

```{r spoken-languages}

movies <- movies %>%
  mutate(spokenlength = str_length(spoken_languages))

movies <- movies %>%
  mutate(english = case_when(
    spokenlength == 40 ~ "yes",
    spokenlength > 40 ~ "no",
    spokenlength < 40 ~ "no"
  ))

```


### Splitting date variable

```{r separate-date-variable}
movies <- movies %>%
  separate(release_date, c("year", "month", "day"), sep = "-")

movies <- movies %>%
  mutate(year = as.numeric(year), month = as.numeric(month), day = as.numeric(day))
```

^^this code chunk should perhaps go somewhere else but insert quick narrative saying how we transformed dates from year-mo-da character form to numerical separate variables

### Genre trends

We wanted to explore how genre affects certain trends within the dataset. Thus we created a few genre related variables that we thought would yield the most effect. 

```{r genre-trends}
movies <- movies %>%
  mutate(horror = ifelse(str_detect(genres, "Horror"), "yes", "no"))
```

```{r}
movies %>%
  group_by(horror) %>%
  summarise(median(budget))
```

We chose the horror genre since we found that horror movies significantly have lower budgets, to see if horror movies then have higher pratios since they have less money to make to "break even" and make a profit. Also, some of the most profitable movies have been horror movies, such as Paranormal Activity, that had a very low budget.

We then tested the question: Does this data provide convincing evidence of a difference in median pratios for horror vs non horror movies?

Null Hypothesis: The movie being a horror movie does cause a difference in median pratio.

```{r}
set.seed(5000)
sampmedian_diff <- movies %>%
  group_by(horror) %>%
  summarise(samp_median = median(pratio)) %>%
  summarise(diff(samp_median)) %>%
  pull()
sampmedian_diff

null_dist <- movies %>%
  specify(response = pratio, explanatory = horror) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("yes", "no"))

ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram(binwidth = .05) +
  geom_vline(xintercept = sampmedian_diff, color = "red") +
  geom_vline(xintercept = -1 * sampmedian_diff, color = "red") +
  labs(title = "Null distribution of differences in medians")

null_dist %>%
  filter(stat <= -sampmedian_diff | stat >= sampmedian_diff ) %>%
  summarise(pvalue = (n() / 1000))

null_dist %>%
  summarise(
    lower = quantile(stat, .025),
    upper = quantile(stat, .975)
  )
```

We found the p-value to be 0, thus it proved to be significantly significant, which we then could accept the null hypothesis that the movie being of a horror genre does affect median pratio. 

Add narrative about confidence interval.

```{r}
horror_only <- movies %>%
  filter(horror == "yes") %>%
  group_by(year) %>%
  mutate(m_pratio = median(pratio)) 

ggplot(horror_only, aes(year, m_pratio)) +
  geom_bar(stat="identity") +
  labs(title = "Change in Median Profitability Ratio of Horror Movies",
       x = "Year",
       y = "Median Profitability Ratio")
```

```{r horror}
horror_count <- horror_only %>%
  count(year)

ggplot(horror_count, aes(year, n)) +
  geom_bar(stat="identity") +
  labs(title = "Change in Number of Horror Movies",
       x = "Year",
       y = "# of Horror Movies")
```


Add narrative about why we chose action:

```{r}
movies <- movies %>%
  mutate(action = ifelse(str_detect(genres, "Action"), "yes", "no"))
movies %>%
  group_by(action) %>%
  summarise(median(budget))
```


```{r}
set.seed(5000)
sampmedian_diff <- movies %>%
  group_by(action) %>%
  summarise(samp_median = median(pratio)) %>%
  summarise(diff(samp_median)) %>%
  pull()
sampmedian_diff

null_dist <- movies %>%
  specify(response = pratio, explanatory = action) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 2000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("yes", "no"))

ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram(binwidth = .05) +
  geom_vline(xintercept = sampmedian_diff, color = "red") +
  geom_vline(xintercept = -1 * sampmedian_diff, color = "red") +
  labs(title = "Null distribution of differences in medians")

null_dist %>%
  filter(stat >= -sampmedian_diff ) %>%
  summarise(pvalue = 2 *(n() / 1000))

null_dist %>%
  summarise(
    lower = quantile(stat, .025),
    upper = quantile(stat, .975)
  )
```

Add narrative about p-value and confidence intervals:

```{r action}

action_only <- movies %>%
  filter(action == "yes") %>%
  group_by(year) %>%
  mutate(m_pratio = median(pratio)) 

ggplot(action_only, aes(year, m_pratio)) +
  geom_bar(stat="identity") +
  labs(title = "Change in Median Profitability Ratio of Action Movies",
       x = "Year",
       y = "Median Profitability Ratio")
```

```{r action-count}
action_count <- action_only %>%
  count(year)

ggplot(action_count, aes(year, n)) +
  geom_bar(stat="identity") +
  labs(title = "Change in Number of Action Movies",
       x = "Year",
       y = "# of Action Movies")
```

### Title and Profitability

```{r words-pratio}
movies <- movies %>%
  mutate(few_words = ifelse(sapply(strsplit(title, " "), length) <= 3, "no", "yes")) 
  
ggplot(movies, mapping = aes(few_words, pratio)) +
  geom_bar(stat="identity")
```

```{r title-test}
sample_stat <- movies %>%
  group_by(few_words) %>%
  summarise(samp_med = median(pratio)) %>%
  summarise(diff(samp_med)) %>%
  pull()

sample_stat
```

```{r title-null-distr}
set.seed(5000)
null_distr <- movies %>%
  specify(response = pratio, explanatory = few_words) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("yes", "no"))
```

```{r title-distr-vis}
ggplot(null_distr, aes(x = stat)) +
  geom_histogram() +
  geom_vline(xintercept = sample_stat, color = "red") +
  geom_vline(xintercept = sample_stat * -1, color = "red")+
  labs(title = "Null Distribution of Differences in Medians")
```

```{r title-p-val}
null_distr %>%
  filter(stat >= sample_stat) %>%
  summarise(pvalue = 2 * (n() / 1000))
```


### Making a variable for holiday releases

```{r holiday-variable}
movies <- movies %>%
  mutate(holiday_release = case_when(
    # Period between day before Christmas Eve and New Year's Eve (inclusive)
    month == 12 & day %in% c(23, 24, 25, 26, 27, 28, 29, 30, 31) ~ "yes",
    # New Year's Day (and the day after), flex period for Martin Luther King Jr. Day
    month == 1 & day %in% c(1, 2, 15, 16, 17, 18, 19, 20, 21) ~ "yes",
    # Valentine's Day (and the days before and after), flex period for Presidents' Day
    month == 2 & day %in% c(13, 14, 15, 16, 17, 18, 19, 20) ~ "yes",
    # Flex period for Memorial Day
    month == 5 & day %in% c(25, 26, 27, 28, 29, 30, 31) ~ "yes",
    # Independence Day (and the days before and after)
    month == 7 & day %in% c(3, 4, 5) ~ "yes",
    # Flex period for Labor Day
    month == 9 & day %in% c(1, 2, 3, 4, 5, 6, 7) ~ "yes",
    # Flex period for Thanksgiving, Veterans' Day (and the days before and after)
    month == 11 & day %in% c(10, 11, 12, 22, 23, 24, 25, 26, 27, 28) ~ "yes",
    TRUE ~ "no"
  ))
```

this is explained in the comments but those wont show in final form so insert narrative about what we consider a holiday and why we wanted to investigate this (a lot of people go to movies around the holidays, etc)

### Making a variable for likely sequels

```{r likely-sequel}
series <- movies$title %>%
  str_detect(":")

sequel2 <- movies$title %>%
  str_detect("2$")

sequel3 <- movies$title %>%
  str_detect("3")

movies <- movies %>%
  mutate(likely_sequel = case_when(
    series == TRUE ~ "yes",
    sequel2 == TRUE ~ "yes",
    sequel3 == TRUE ~ "yes",
    TRUE ~ "no"
  ))
```

this basically sorts for titles that inlcude ":" or end with "2" or "3" to create a list of movies that are probably part of series (not a perfect variable just an approximation). we wanted to look at this because some sequels of really good movies flop etc. but a good first movie tends to motivate people to go see the next one

### Making a variable for major production companies

```{r major-production-company}
universal_list <- movies$production_companies %>%
  str_detect("Universal Pictures")

paramount_list <- movies$production_companies %>%
  str_detect("Paramount Pictures")

warner_list <- movies$production_companies %>%
  str_detect("Warner Bros.")

disney_list <- movies$production_companies %>%
  str_detect("Walt Disney Pictures")

columbia_list <- movies$production_companies %>%
  str_detect("Columbia Pictures")

dreamworks_list <- movies$production_companies %>%
  str_detect("DreamWorks")

twentiethc_list <- movies$production_companies %>%
  str_detect("Twentieth Century Fox Film Corporation")

lionsgate_list <- movies$production_companies %>%
  str_detect("Lionsgate")

marvel_list <- movies$production_companies %>%
  str_detect("Marvel Studios")

pixar_list <- movies$production_companies %>%
  str_detect("Pixar Animation Studios")

movies <- movies %>%
  mutate(if_major = case_when(
    universal_list == TRUE ~ "yes",
    paramount_list == TRUE ~ "yes",
    warner_list == TRUE ~ "yes", 
    disney_list == TRUE ~ "yes",
    columbia_list == TRUE ~ "yes",
    dreamworks_list == TRUE ~ "yes",
    twentiethc_list == TRUE ~ "yes",
    lionsgate_list == TRUE ~ "yes",
    marvel_list == TRUE ~ "yes",
    pixar_list == TRUE ~ "yes",
    TRUE ~ "no"
  )) %>%
  mutate(major_productionco = case_when(
    universal_list == TRUE ~ "universal",
    paramount_list == TRUE ~ "paramount",
    warner_list == TRUE ~ "warner",
    disney_list == TRUE ~ "disney",
    columbia_list == TRUE ~ "columbia",
    dreamworks_list == TRUE ~ "dreamworks",
    twentiethc_list == TRUE ~ "20thc",
    lionsgate_list == TRUE ~ "lionsgate",
    marvel_list == TRUE ~ "marvel",
    pixar_list == TRUE ~ "pixar",
    TRUE ~ "other"
  ))
```

Major production companies according to Wikipedia are Universal Pictures (NBCUniversal), Paramount Pictures (Viacom), WarnerBros. Pictures (WarnerMedia), Walt Disney Pictures (Walt Disney Studios), Columbia Pictures (Sony Pictures) (in the format Major film studio unit (Studio parent) from https://en.wikipedia.org/wiki/Major_film_studio#Present_2) 

we got lionsgate, dreamworks, and twentieth century fox from a list at https://reelrundown.com/film-industry/Top-10-Movie-Production-Companies to add more major companies to our analysis (maybe look at website real quick to say why this is)

and also pixar and marvel are notorious for having very popular, profitable movies (also with endgame coming out and skyrocketing to the top of popularity charts on imdb, tmdb, etc.) we added these as well

```{r bar-graph-production-companies}
pc_analysis <- movies %>%
  group_by(major_productionco) %>%
  summarise(median = median(pratio))

ggplot(data = pc_analysis, aes(x = reorder(major_productionco, median), y = median, fill = major_productionco)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

Insert narrative interpreting the bar graph

Simulating if production companies have cause a difference in median pratio:

Add what the null hypothesis is:

```{r}
sampmedian_diff <- movies %>%
  filter(!is.na(if_major) & !is.na(pratio)) %>%
  group_by(if_major) %>%
  summarise(samp_median = median(pratio)) %>%
  summarise(diff(samp_median)) %>%
  pull()
sampmedian_diff
```

```{r}
set.seed(5000)
null_dist <- movies %>%
  specify(response = pratio, explanatory = if_major) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("yes", "no"))

ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram(binwidth = .05) +
  geom_vline(xintercept = sampmedian_diff, color = "red") +
  geom_vline(xintercept = -1 * sampmedian_diff, color = "red") +
  labs(title = "Null distribution of differences in medians")

null_dist %>%
  filter(stat <= sampmedian_diff ) %>%
  summarise(pvalue = 2 *(n() / 1000))

null_dist %>%
  summarise(
    lower = quantile(stat, .025),
    upper = quantile(stat, .975)
  )
```

Add narrative about confidence interval and p-value:


### Making a variable for tagline length

```{r tagline-length}
movies <- movies %>%
  mutate(tag_length = str_length(tagline))
movies
```

either explain this or get rid of it tbh (but we do need something to be eliminated from our linear model later on so maybe its worth it)

### Making a preliminary linear model

We aim to find an ideal linear model to predict profitability ratio based on a variety of factors; before constructing our model, we will remove observations that lack values for these factors. 

```{r filter-data}
# filter for NAs (no NAs in holiday_release, likely_sequel, budget, if_major, major_productionco, vote_average, vote_count, english, horror )
movies_filt <- movies %>%
  filter(!is.na(tag_length))

movies_filt <- movies_filt %>%
  mutate(major_productionco = fct_relevel(major_productionco, "other"))
movies 
```

We filter the dataset to remove movies with NA values so that our backwards model selection will work (the only NAs in the values we are considering are for tagline length)

```{r preliminary-linear-model}
m_pratio <- lm(pratio ~ holiday_release + likely_sequel + budget + if_major + major_productionco + tag_length + english + runtime + action + horror + runtime + few_words + budget*if_major + likely_sequel*budget, data = movies_filt)
m_pratio

tidy(m_pratio) %>%
  select(term, estimate)

```

We fit a regression model to predict pulse rate based on holiday_release, likely_sequel, budget, if_major, major_productionco, tag_length, english, runtime, action, horror, few_words, the interaction between budget and likely_sequel, and the interaction between budget and if_major. We chose to examine the those interactions because whether a movie is a sequel (and thus has a known revenue for its precedents and some expectation that people will see it) may be related to its budget and also the relation between budget and having access to the resources we assume accompany a major production company may also be related in an interesting way.

Linear Model: 

Profitability Ratio = `r tidy(m_pratio)[1,2]` + `r tidy(m_pratio)[2,2]`(Holiday Release) + `r tidy(m_pratio)[3,2]`(Likely Sequel) + `r tidy(m_pratio)[4,2]`(Budget) + `r tidy(m_pratio)[5,2]`(Major Production Company) + `r tidy(m_pratio)[6,2]`(20th Century Fox) `r tidy(m_pratio)[7,2]`(Columbia) + + `r tidy(m_pratio)[8,2]`(Disney) + `r tidy(m_pratio)[9,2]`(DreamWorks) + `r tidy(m_pratio)[10,2]`(Lionsgate) + `r tidy(m_pratio)[11,2]`(Marvel) + `r tidy(m_pratio)[12,2]`(Paramount) + `r tidy(m_pratio)[13,2]`(Pixar) + `r tidy(m_pratio)[14,2]`(Universal) + `r tidy(m_pratio)[15,2]`(Tagline Length) + `r tidy(m_pratio)[16,2]`(Spoken Language English) + `r tidy(m_pratio)[17,2]`(Runtime) + `r tidy(m_pratio)[18,2]`(Action) + `r tidy(m_pratio)[19,2]`(Horror) + `r tidy(m_pratio)[20,2]`(One Word Title) + `r tidy(m_pratio)[21,2]`(Budget * Major Production Company) + `r tidy(m_pratio)[22,2]`(Likely Sequel * Budget)

```{r r-orig-model}
glance(m_pratio)

rsq <- glance(m_pratio)$adj.r.squared
```

We compute the adjusted R-squared value for the filtered model for pulse as `r rsq`; this is a helpful measure of the goodness of the fit of the model.

```{r aic-model-selection}
selected_m_pratio <- step(m_pratio, direction = "backward")

tidy(selected_m_pratio) %>% 
  select(term, estimate)
```

We perform backwards model selection based on AIC, Akaike Information Criterion (another measure of the fit of a model), and obtain the best fit.

Selected Linear Model: 

Profitability Ratio = `r tidy(selected_m_pratio)[1,2]` + `r tidy(selected_m_pratio)[2,2]`(Holiday Release) + `r tidy(selected_m_pratio)[3,2]`(Likely Sequel) + `r tidy(selected_m_pratio)[4,2]`(Budget) + `r tidy(selected_m_pratio)[5,2]`(Major Production Company) + `r tidy(selected_m_pratio)[6,2]`(Spoken Language English) + `r tidy(selected_m_pratio)[7,2]`(Runtime) + `r tidy(selected_m_pratio)[8,2]`(Action) + `r tidy(selected_m_pratio)[9,2]`(Horror) + `r tidy(m_pratio)[10,2]`(One Word Title) + `r tidy(m_pratio)[11,2]`(Budget * Major Production Company) + `r tidy(m_pratio)[12,2]`(Likely Sequel * Budget)

```{r aic-model-comparison}
glance(m_pratio)$AIC
glance(selected_m_pratio)$AIC
```

Our AIC value decreases for the selected model, which indicates that it is a better fit. Thus factors of holiday_release, likely_sequel, budget, ETC TYPE THE REST HERE are the best predictors of profitability. 

```{r rsq-selected-model}
newrsq <- glance(selected_m_pratio)$r.squared
newrsq
```

Our R-squared value of `r newrsq` for our final selected model indicates that `r newrsq *100`% of the variation in profitability ratio can be well-explained by a linear relationship with INSERT LIST HERE

### A quick look at budget vs revenue

```{r budget-revenue-model}
m_revenue <- lm(revenue ~ budget, data = movies)

tidy(m_revenue) %>%
  select(term, estimate)

rsq_mrevenue <- glance(m_revenue)$r.squared
```

`r rsq_mrevenue` explain this r squared

```{r visualize-revenue-model}
ggplot(data = movies, aes(x = budget, y = revenue, color = if_major)) +
  geom_jitter(alpha = .3) +
  stat_smooth(method = "lm", se = FALSE)
```

explain this visualization

### Conclusion



