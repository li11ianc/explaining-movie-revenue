---
title: "Hollywood Big-Bucks"
author: "Zuck(R)berg"
date: "25 April 2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

### Introduction

The movie industry is one that accounts for billions of dollars in revenue and forms the keystone of the entertainment sector; consequently, there are a wide variety of films that have had varying degrees of success in the market. There are a variety of characteristics and factors that make up a movie – budget, director, etc. – yet none of these factors alone seem to have the power to drive a successful film. Rather, a combination of positive factors must be achieved to dominate the market. In this project, we will be attempting to address the research question of what specific factors have the most effect in predicting the profitability of a film. 

### Beginning Steps

In order to conduct our analysis, we will be using a dataset from Kaggle known as the “TMBD 5000 Movie Dataset”. This dataset is a collection of 5000 movies and various characteristics, including budget, revenue, the spoken language of the film, and various other traits. 

```{r load-data, message=FALSE}
library(tidyverse)
library(dplyr)
library(broom)
library(stringr)
library(infer)

set.seed(5000)

movies <- read_csv("/cloud/project/data/tmdb_5000_movies.csv")
movies <- movies %>%
  select(-id, -homepage, -original_title)
movies <- movies %>%
  filter(original_language == "en")
movies <- movies %>%
  filter(budget > 0) %>%
  filter(revenue > 0)

```

There are a few variables we will remove from the dataset, as they aren’t particularly useful for our analysis; among them are “id”, “homepage”, and “original_title”, as these variables are not related to the films themselves but serve only to identify the movies within a database. 

Furthermore, we have filtered the original dataset for only movies whose original_language is listed as Engish. While this does cut out a significant portion of the dataset, it was necessary due to a problem we encountered with the budget and revenue variables – they weren’t all in USD. While an English filter isn’t a perfect discriminator for American currency values, it serves as a useful proxy and reduces the currency discrepancy to a level that is statistically insignificant. 

We have also filtered out movies that have values of zero for budget and/or revenue. As our analysis focuses on how movies become successful, we felt that movies with zero values were not seriously seeking financial success, and consequently may skew our results since the films were not designed to draw profits. 

Here is a visualization of the distribution of the "popularity" variable as well as its top 10 observations within the dataset.

```{r popularity-explanations}
ggplot(data = movies, aes(y = popularity)) +
  geom_boxplot() +
  labs(title = "Distribution of Popularity Score", x = "", y = "Popularity Score")

movies %>%
  select(title, popularity) %>%
  arrange(desc(popularity)) %>%
  head(10)
```

The “popularity” variable is another that we have decided to omit; as you can see based on the above visualization and an ordered list of the top 10 movies by “popularity”, there are a number of irregularities with the variable. Firstly, popularity itself is not clearly defined by the creators of the dataset, and consequently it is difficult to form any useful statistical conclusion from its analysis. Furthermore, the distribution of popular movies is odd, with a huge number of upper outliers and significant right-skew. Finally, the intuitive definitions of popularity – number of viewings, number of people that have seen the film, or otherwise – are not apparent in the above top 10 list of “popular” movies. While Minions and Interstellar are certainly well-known films, they pale in comparison to more well-known movies that actually don’t appear on this list at all. If one conducts a search for “most popular movies”, the list that appears does not share a single entry in common with the above 10 terms. Due to these strange findings, popularity will also be omitted from our analysis. 

At first, we hypothesized that budget would be the strongest indicator of success; intuitively, companies that can afford to invest hundreds of millions of dollars into a film are unlikely to lack the expertise to profit from their creation. Out of a combination of this sentiment and general curiosity, we compiled a list of the top 10 movies arranged by budget. 

```{r high-budget-list}
movies %>%
  select(title, budget) %>%
  arrange(desc(budget)) %>%
  head(10)
movies %>%
  distinct(production_companies)
```

The results were actually quite surprising; around half of the films on the list received significant negative press coverage and failed to meet revenue expectations for movies of their caliber. At this point, we became intrigued – what factors did these high budget movies lack that might have improved their box office performance?

```{r prod-comp}
movies %>%
  distinct(production_companies)
```

We also took a cursory look at some of the production companies listed in the dataset. Unsurprisingly, a large portion of the dataset’s movies were created by name-brand companies, a fact that suggests that financial resources must not have been the primary reason for the failure of many movies. 

### Creating "Profitability" Variables

In order to investigate the financial success of movies, we defined two variables which we will hereafter refer to as “profitability” variables. The first of these, pratio, is a ratio of revenue to budget that expresses the percentage by which a movie earns more or less than its budget. For example, a movie that has a revenue twice its budget will have a pratio of 2. This variable is numerical and continuous; to aid in our analysis, we’ve created a second, categorical variable called “profitable” that divides movies into two categories – profitable or not. If the pratio is greater than 1, the movie is profitable and displays an entry of “yes”. If not, then the observation is listed as “no”. 

```{r profit-variable}
movies <- movies %>% 
  mutate(pratio = revenue/budget) 
movies <- movies %>%
  mutate(profit = case_when(
    pratio > 1 ~ "yes",
    pratio <= 1 ~ "no"
  )
  )
movies <- movies %>%
  filter(pratio <= 200)

```

Initially, the pratio variable displayed summary statistics that were entirely unreasonable – a mean pratio of over one hundred, for example – and we discovered the cause quickly; some movies listed their budgets in units of one million dollars while their revenues were recorded in simple USD. Consequently, their pratios were in the hundreds of thousands. In order to fix this, we did additional research and found that the highest true pratio in a movie belongs to “Paranormal Activity” with a value of around 200. Consequently, all values above 200 are data-entry errors and were filtered out. Fortunately, there are no erroneous entries below 200, as budget entry errors relating to the millions unit have a minimum effect on pratio of 6 orders of magnitude. 

In analyzing pratio, we will begin with a 95% confidence interval of the median pratios for films to get a general sense of where the median value might lie.

```{r confinterva-pratio}
set.seed(5000)
boot_dist <- movies %>%
  specify(response = "pratio") %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "median")

boot_dist %>%
  summarise(
    lower = quantile(stat, 0.025),
    uppper = quantile(stat, 0.975)
  )
```

The above values, 2.20 and 2.39, allow me to state with 95% confidence that the true median pratio for movies lies between 2.20 and 2.39. This conclusion is surprising; one would intuitively expect a majority, or at least sizeable minority, of movies to achieve break-even status or less. Rather, the confidence interval establishes that, with 95% certainty, around half of movies – those greater than the median – have pratios in excess of 2.20 while far less than half of movies fail to be profitable.  Making a successful movie may be easier than we thought!

After the above glance at profitability in general, we will now create a few more variables with which to analyze profitability and examine some different trends.

### Categorical Spoken English Variable

Recall that we originally filtered the data for movies whose “original_language” was English; there are a multitude of movies who still features spoken languages other than English. Consequently, we will be mutating a new variable, “english” which splits movies into two groups – those that are entirely spoken in English and those that feature other languages. We will use this variable later in our analysis, but we hypothesize that English-only movies will earn higher revenues. 

```{r spoken-languages}

movies <- movies %>%
  mutate(spokenlength = str_length(spoken_languages))

movies <- movies %>%
  mutate(english = case_when(
    spokenlength == 40 ~ "yes",
    spokenlength > 40 ~ "no",
    spokenlength < 40 ~ "no"
  ))

```


### Numerical Split Date Variable 

We will now wrangle the dates in the dataset for use in the next segment, a process which requires us to convery the dates in the data to a better form. The dates in the dataset originally came in character form as “yr-mo-day," but character format isn’t particularly useful for analyzing dates – rather, a numeric form is preferred. We split the character format into 3 parts and converted the values to 3 numeric variables as day, month, and year. 

```{r separate-date-variable}
movies <- movies %>%
  separate(release_date, c("year", "month", "day"), sep = "-")

movies <- movies %>%
  mutate(year = as.numeric(year), month = as.numeric(month), day = as.numeric(day))
```


### Genre Trends

Now that we have a proper format for our dates, we can analyze another characteristic’s effect on profitability over time – genre. In order to create a genre variable, we used a string detect function that scans for “Horror” under a movie’s genres. We have decided to work with the “horror” genre specifically as we noticed that they generally have lower budgets than other types of films. See below a table that reflects the stark difference – non-horror movies seem to cost nearly twice as much.

```{r genre-trends}
movies <- movies %>%
  mutate(horror = ifelse(str_detect(genres, "Horror"), "yes", "no"))
```

```{r horror-medians}
movies %>%
  group_by(horror) %>%
  summarise(median(budget))
```

As a result, it’s easier for a horror movie to achieve a high pratio, a fact which is reflected in the movie with the highest pratio – Paranormal Activity with a value of nearly 200! We formulated the following question in regard to horror movies. 

Does this data provide convincing evidence of a difference in median pratios for horror vs non-horror movies?

Null Hypothesis: A movie’s status as a horror film is independent of its pratio.

Alternative Hypothesis: A movie’s status as a horror film is a dependency for its pratio.

The below value is the sample median difference in pratios between horror and non-horror movies – at .5147, our sample’s horror movies had a 50% higher return on their budgets than in non-horror movies. In order to generalize, however, we must run a hypothesis test. Below is our generated null distribution for a difference in medians (horror – non-horror) with 1000 repetitions, as well as upper and lower bounds of +/- .5147. By running a hypothesis test for independence with an alpha value of .05, we found a p-value of .004, a value which gives convincing evidence to reject the null hypothesis and conclude that horror movies have higher pratios.

```{r hypotest-horror}
set.seed(5000)
sampmedian_diff <- movies %>%
  group_by(horror) %>%
  summarise(samp_median = median(pratio)) %>%
  summarise(diff(samp_median)) %>%
  pull()
sampmedian_diff

null_dist <- movies %>%
  specify(response = pratio, explanatory = horror) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("yes", "no"))

ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram(binwidth = .05) +
  geom_vline(xintercept = sampmedian_diff, color = "red") +
  geom_vline(xintercept = -1 * sampmedian_diff, color = "red") +
  labs(title = "Null distribution of differences in medians")

null_dist %>%
  filter(stat <= -sampmedian_diff | stat >= sampmedian_diff ) %>%
  summarise(pvalue = (n() / 1000))

null_dist %>%
  summarise(
    lower = quantile(stat, .025),
    upper = quantile(stat, .975)
  )
```

By running a hypothesis test for independence with an alpha value of .05, we found a p-value of .004, a value which gives convincing evidence to reject the null hypothesis and conclude that horror movies have higher pratios.

We also ran a 95% confidence interval for the true median difference in pratio. The displayed interval, (-.274, .381). allows us to state with 95% confidence that the true median difference in pratios between horror and non-horror movies, subtracting the latter from the former, is between -.274 and .381. 

Using our newly-created date values, we also wanted to track profitability of horror movies over time as well as the sheer number of horror movies created. Below are two visualizations: first, an examination of the profitability over time and secondly a glance at the number of horror movies created in each year. 

```{r profitability-horror}
horror_only <- movies %>%
  filter(horror == "yes") %>%
  group_by(year) %>%
  mutate(m_pratio = median(pratio)) 

ggplot(horror_only, aes(year, m_pratio)) +
  geom_bar(stat="identity") +
  labs(title = "Change in Median Profitability Ratio of Horror Movies",
       x = "Year",
       y = "Median Profitability Ratio")
```

```{r horror-frequency}
horror_count <- horror_only %>%
  count(year)

ggplot(horror_count, aes(year, n)) +
  geom_bar(stat="identity") +
  labs(title = "Change in Number of Horror Movies",
       x = "Year",
       y = "# of Horror Movies")
```

The relationship between these two graphs is interesting, as they seem to mirror each other to a certain extent. Observe two main similarities. Firstly, they are both bimodal with modes appearing around the 1990s and 2010s, although the second graph’s first “mode” is dwarfed by the 2010s mode in a way that doesn’t apply to the first graph. Secondly, they both experience low values at the same time; these two observations can be well-explained by an economic theory. Simply put, the more profitable that producing a movie is, the more movies that will be created. 

The next genre that we’ll examine is action, a genre that we chose for its antithetical nature to horror. Action budgets seem to be extraordinarily large in comparison to other genres, as shown by the below chart. 

```{r action-variable}
movies <- movies %>%
  mutate(action = ifelse(str_detect(genres, "Action"), "yes", "no"))
movies %>%
  group_by(action) %>%
  summarise(median(budget))
```

Action movies have a median budget of more than twice that of other movies’ median budget. We’ve also gone ahead and calculated a sample difference of pratios between action and non-action movies (in that order) for our sample – a value of -.223. In a very similar procedure to the horror movies, we’ve created a null distribution of 2000 values of the differences in median pratio between action movies and non-action movies.

```{r hypotest-action}
set.seed(5000)
sampmedian_diff <- movies %>%
  group_by(action) %>%
  summarise(samp_median = median(pratio)) %>%
  summarise(diff(samp_median)) %>%
  pull()
sampmedian_diff

null_dist <- movies %>%
  specify(response = pratio, explanatory = action) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("yes", "no"))

ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram(binwidth = .05) +
  geom_vline(xintercept = sampmedian_diff, color = "red") +
  geom_vline(xintercept = -1 * sampmedian_diff, color = "red") +
  labs(title = "Null distribution of differences in medians")

null_dist %>%
  filter(stat >= -sampmedian_diff | stat <= sampmedian_diff) %>%
  summarise(pvalue = (n() / 1000))

null_dist %>%
  summarise(
    lower = quantile(stat, .025),
    upper = quantile(stat, .975)
  )
```

From our hypothesis test, we found a p-value of .039 – below our alpha level of .05. Thus, we do have convincing evidence to reject a null hypothesis of no difference in pratios, thus concluding that there is evidence of a difference in median pratios between action movies and non action movies. We’ve also computed a 95% confidence interval for the true median difference between action and non-action movies in that order, arriving at values of -0.188 and .215. Consequently, we can state with 95% confidence that the true typical difference in median pratios for action and non-action movies lies between -.185 and .227. 

In a similar process, we examined the profitability and frequency of action movies over time. 

```{r action}

action_only <- movies %>%
  filter(action == "yes") %>%
  group_by(year) %>%
  mutate(m_pratio = median(pratio)) 

ggplot(action_only, aes(year, m_pratio)) +
  geom_bar(stat="identity") +
  labs(title = "Change in Median Profitability Ratio of Action Movies",
       x = "Year",
       y = "Median Profitability Ratio")
```

```{r action-count}
action_count <- action_only %>%
  count(year)

ggplot(action_count, aes(year, n)) +
  geom_bar(stat="identity") +
  labs(title = "Change in Number of Action Movies",
       x = "Year",
       y = "# of Action Movies")
```

Again, the plots look very similar, but rather than sharing key points as the horror movies did, the action genre’s plots share a steady upward trend beginning in the 1990s. Again, profitability may be driving more movies to be created out of economic incentivization. 

### Title and Profitability

The next factor we’ll be examining is the title of a movie with specific attention to the length of the title. Intuition isn’t much use here; longer titles and shorter titles seem equally likely to garner revenue. In order to get a general idea of how title length might affect the pratio, we will examine the medians for long and short movie titles.

```{r words-pratio}
movies <- movies %>%
  mutate(few_words = ifelse(sapply(strsplit(title, " "), length) <= 3, "no", "yes")) 
temp_title <- movies %>%
  group_by(few_words) %>%
  summarise(med_pratio = median(pratio)) %>%
  ungroup()
  
ggplot(temp_title, mapping = aes(few_words, med_pratio)) +
  geom_bar(stat="identity") +
  labs(title = "Median Profitability Ratios of Movies With Longer and Shorter Titles",
       x = "3 Words or Less?",
       y = "Median Profitability Ratio")
```

Interestingly, there does appear to be a greater pratio for films with a title of three words or less! Below, we've calculated the exact difference in our sample to be a difference in medians of approximately .36. In order to generalize our results, however, we must conduct a hypothesis test.

```{r title-test}
sample_stat <- movies %>%
  group_by(few_words) %>%
  summarise(samp_med = median(pratio)) %>%
  summarise(diff(samp_med)) %>%
  pull()

sample_stat
```

We will conduct a hypothesis test for independence with the following null hypothesis.

Null Hypothesis: Pratio is independent of title length.

Alternative Hypothesis: Pratio is dependent on title length. 

Using the sample median above, we will create a null distribution of the difference in medians ("yes" - "no") with 1000 repetitions and a permutation simulation type. 

```{r title-null-distr}
set.seed(5000)
null_distr <- movies %>%
  specify(response = pratio, explanatory = few_words) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("yes", "no"))
```

```{r title-distr-vis}
ggplot(null_distr, aes(x = stat)) +
  geom_histogram(binwidth = .02) +
  geom_vline(xintercept = sample_stat, color = "red") +
  geom_vline(xintercept = sample_stat * -1, color = "red")+
  labs(title = "Null Distribution of Differences in Medians")
```

```{r title-p-val}
null_distr %>%
  filter(stat >= sample_stat) %>%
  summarise(pvalue = 2 * (n() / 1000))
```

By using our sample median difference and applying its bounds to the null distribution, we arrive at a p-value of .008, which is below the alpha level and offers convincing evidence for us to reject the null hypothesis and conclude that pratio is dependent on title length. 

After analyzing title length, we’re going to create a few more variables in preparation for our linear model. Specifically, we will create below the variables for holiday release, sequels, major production company status, and tagline length. 

### Holiday Releases

Holiday releases – releasing on Halloween, Christmas, and other major festivities – might gather more revenues, due to the greater amount of disposable income being spent on these days. In order to create a categorical variable for holiday release, we filtered for movies released on dates on or directly around specific holidays and holiday periods. This variable is categorical and returns an answer of “yes” for holidays and “no” for non-holidays. 

```{r holiday-variable}
movies <- movies %>%
  mutate(holiday_release = case_when(
    # Period between day before Christmas Eve and New Year's Eve (inclusive)
    month == 12 & day %in% c(23, 24, 25, 26, 27, 28, 29, 30, 31) ~ "yes",
    # New Year's Day (and the day after), flex period for Martin Luther King Jr. Day
    month == 1 & day %in% c(1, 2, 15, 16, 17, 18, 19, 20, 21) ~ "yes",
    # Valentine's Day (and the days before and after), flex period for Presidents' Day
    month == 2 & day %in% c(13, 14, 15, 16, 17, 18, 19, 20) ~ "yes",
    # Flex period for Memorial Day
    month == 5 & day %in% c(25, 26, 27, 28, 29, 30, 31) ~ "yes",
    # Independence Day (and the days before and after)
    month == 7 & day %in% c(3, 4, 5) ~ "yes",
    # Flex period for Labor Day
    month == 9 & day %in% c(1, 2, 3, 4, 5, 6, 7) ~ "yes",
    # Halloween (and the days before and after)
    month == 10 & day %in% c(30, 31) ~ "yes",
    # Flex period for Thanksgiving, Veterans' Day (and the days before and after)
    month == 11 & day %in% c(1, 10, 11, 12, 22, 23, 24, 25, 26, 27, 28) ~ "yes",
    TRUE ~ "no"
  ))
```

We will use this variable later in a final linear model.

### Likely Sequels

```{r likely-sequel}
series <- movies$title %>%
  str_detect(":")

sequel2 <- movies$title %>%
  str_detect("2$")

sequel3 <- movies$title %>%
  str_detect("3")

movies <- movies %>%
  mutate(likely_sequel = case_when(
    series == TRUE ~ "yes",
    sequel2 == TRUE ~ "yes",
    sequel3 == TRUE ~ "yes",
    TRUE ~ "no"
  ))
```

We’ve also created a variable for likely sequels; the “likely” refers to the fact that our system for generating this variable relies on the most obvious indicators and will likely have both false negatives and false positives. However, the system is reliable enough for our purposes in this investigation. Essentially, we mutated likely_sequel to return a “yes” response if a string detect detects a 2 or 3 at the end of a movie’s title or a colon within the title, both of which commonly appear in members of a series. We suspect that a movie’s status as a sequel will decrease its revenue, since many believe that sequels tend to be worse than their predecessors. On the other hand, sequels draw additional revenue since fans of a prior movie will commit to seeing the new version. 


### Major Production Companies

The next variable that we’ve created is “if_major”, which expresses whether a given movie is a created by a major production company. We’ve determined which studios are “major” based on some outside research; the list of major producers includes Universal Pictures, Paramount Pictures, WarnerBros. Pictures, Walt Disney Pictures, Columbia Pictures, Lionsgate, Dreamworks, Twentieth Century Fox, Pixar, and Marvel. In order to create this variable, we used a sequence of str_detect functions and converted their results with a case_when function.

```{r major-production-company}
universal_list <- movies$production_companies %>%
  str_detect("Universal Pictures")

paramount_list <- movies$production_companies %>%
  str_detect("Paramount Pictures")

warner_list <- movies$production_companies %>%
  str_detect("Warner Bros.")

disney_list <- movies$production_companies %>%
  str_detect("Walt Disney Pictures")

columbia_list <- movies$production_companies %>%
  str_detect("Columbia Pictures")

dreamworks_list <- movies$production_companies %>%
  str_detect("DreamWorks")

twentiethc_list <- movies$production_companies %>%
  str_detect("Twentieth Century Fox Film Corporation")

lionsgate_list <- movies$production_companies %>%
  str_detect("Lionsgate")

marvel_list <- movies$production_companies %>%
  str_detect("Marvel Studios")

pixar_list <- movies$production_companies %>%
  str_detect("Pixar Animation Studios")

movies <- movies %>%
  mutate(if_major = case_when(
    universal_list == TRUE ~ "yes",
    paramount_list == TRUE ~ "yes",
    warner_list == TRUE ~ "yes", 
    disney_list == TRUE ~ "yes",
    columbia_list == TRUE ~ "yes",
    dreamworks_list == TRUE ~ "yes",
    twentiethc_list == TRUE ~ "yes",
    lionsgate_list == TRUE ~ "yes",
    marvel_list == TRUE ~ "yes",
    pixar_list == TRUE ~ "yes",
    TRUE ~ "no"
  )) %>%
  mutate(major_productionco = case_when(
    universal_list == TRUE ~ "universal",
    paramount_list == TRUE ~ "paramount",
    warner_list == TRUE ~ "warner",
    disney_list == TRUE ~ "disney",
    columbia_list == TRUE ~ "columbia",
    dreamworks_list == TRUE ~ "dreamworks",
    twentiethc_list == TRUE ~ "20thc",
    lionsgate_list == TRUE ~ "lionsgate",
    marvel_list == TRUE ~ "marvel",
    pixar_list == TRUE ~ "pixar",
    TRUE ~ "other"
  ))
```

Below is a visualization of the median pratio for each of the listed studios. 

```{r bar-graph-production-companies}
pc_analysis <- movies %>%
  group_by(major_productionco) %>%
  summarise(median = median(pratio))

ggplot(data = pc_analysis, aes(x = reorder(major_productionco, median), y = median, fill = major_productionco)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Median Profitability Ratio by Major Production Company", 
       x = "Production Company", y = "Median Pratio") +
  scale_fill_discrete(name = "Production Company")
```

Interestingly, the medians tend to be lower than we predicted; assuming that greater budget leads to greater revenue, these major producers should be achieving maximum profitability, which they clearly do not with the exception of Pixar, who outperforms the other companies by two to three times as much profitability. In order to be certain about major companies as a whole, however, we ran a hypothesis test below. 

First, we computed our sample difference on which to base the test – we found a median difference of .633 between major and non-major production companies in our sample.

```{r sample-median-calc}
sampmedian_diff <- movies %>%
  filter(!is.na(if_major) & !is.na(pratio)) %>%
  group_by(if_major) %>%
  summarise(samp_median = median(pratio)) %>%
  summarise(diff(samp_median)) %>%
  pull()
sampmedian_diff
```

Now, we will establish a null and alternative hypothesis.

Null: There is no difference in pratio based on a relationship with major and non-major production companies.

Alternative: There is a difference in pratio based on a relationship with major and non-major production companies.

```{r hypotest-major}
set.seed(5000)
null_dist <- movies %>%
  specify(response = pratio, explanatory = if_major) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in medians", order = c("yes", "no"))

ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram(binwidth = .05) +
  geom_vline(xintercept = sampmedian_diff, color = "red") +
  geom_vline(xintercept = -1 * sampmedian_diff, color = "red") +
  labs(title = "Null distribution of differences in medians")

null_dist %>%
  filter(stat <= -.633 | stat >= .633 ) %>%
  summarise(pvalue = (n() / 1000))

null_dist %>%
  summarise(
    lower = quantile(stat, .025),
    upper = quantile(stat, .975)
  )
```

Generating a null distribution of 1000 values and applying our sample statistic bounds, we find a p-value of zero, suggesting that there is convincing evidence that there is a difference in pratio between major and non-major production companies. Furthermore, based on the above values for a 95% confidence interval, we can state with 95% confidence that the true difference in median pratio between major and non-major produced movies is between -.183 and .198.


### Tagline Length

The next variable we’ve created is tagline length – this is a simple measurement of the character length of the movie’s tagline or “promotional statement” generally attached to the movie’s promotional materials. 

```{r tagline-length}
movies <- movies %>%
  mutate(tag_length = str_length(tagline))
movies %>%
  select(tagline) %>%
  head(10)
```

Here are a few examples of movie taglines. We have applied a str_length function to each tagline to form our tagline length variable "tag_length". 

### Preliminary Linear Model

We aim to find an ideal linear model to predict profitability ratio based on a variety of factors; before constructing our model, we will remove observations that lack values for these factors. 

```{r filter-data}
# filter for NAs (no NAs in holiday_release, likely_sequel, budget, if_major, major_productionco, vote_average, vote_count, english, horror )
movies_filt <- movies %>%
  filter(!is.na(tag_length))

movies_filt <- movies_filt %>%
  mutate(major_productionco = fct_relevel(major_productionco, "other"))
```

Now that we’ve created all of our variables, we can begin to create a linear model to try and predict profitability. First, we have removed all NA values for the variables under consideration, although this step is not shown. However, the only NA values in the dataset were present in the new tagline variable. 

Below, we've fitted an initial linear model which takes into account all of the variables previously mentioned as well as a few interactions: budget and if_major, due to the clear relationship between being a major company and having access to a large budget, and budget * likely_sequel, due to the funding relationship that a movie might have with a successful predecessor.

```{r preliminary-linear-model}
m_pratio <- lm(pratio ~ holiday_release + likely_sequel + budget + if_major + major_productionco + tag_length + english + runtime + action + horror + runtime + few_words + budget*if_major + likely_sequel*budget, data = movies_filt)
m_pratio

tidy(m_pratio) %>%
  select(term, estimate)
```

Linear Model: 

Profitability Ratio = `r tidy(m_pratio)[1,2]` + `r tidy(m_pratio)[2,2]`(Holiday Release) + `r tidy(m_pratio)[3,2]`(Likely Sequel) + `r tidy(m_pratio)[4,2]`(Budget) + `r tidy(m_pratio)[5,2]`(Major Production Company) + `r tidy(m_pratio)[6,2]`(20th Century Fox) `r tidy(m_pratio)[7,2]`(Columbia) + + `r tidy(m_pratio)[8,2]`(Disney) + `r tidy(m_pratio)[9,2]`(DreamWorks) + `r tidy(m_pratio)[10,2]`(Lionsgate) + `r tidy(m_pratio)[11,2]`(Marvel) + `r tidy(m_pratio)[12,2]`(Paramount) + `r tidy(m_pratio)[13,2]`(Pixar) + `r tidy(m_pratio)[14,2]`(Universal) + `r tidy(m_pratio)[15,2]`(Tagline Length) + `r tidy(m_pratio)[16,2]`(Spoken Language English) + `r tidy(m_pratio)[17,2]`(Runtime) + `r tidy(m_pratio)[18,2]`(Action) + `r tidy(m_pratio)[19,2]`(Horror) + `r tidy(m_pratio)[20,2]`(Few Word Title) + `r tidy(m_pratio)[21,2]`(Budget * Major Production Company) + `r tidy(m_pratio)[22,2]`(Likely Sequel * Budget)


```{r r-orig-model}
rsq <- glance(m_pratio)$adj.r.squared
```

We compute the adjusted R-squared value for the model as `r rsq`; this is a helpful measure of the goodness of the fit of the model.

Below, we have performed backwards selection on our preliminary model and arrive at an optimal model.

```{r aic-model-selection}
selected_m_pratio <- step(m_pratio, direction = "backward")

tidy(selected_m_pratio) %>% 
  select(term, estimate)
```

We performed backwards selection based on AIC. Consequently, our selected model has a lower AIC value than the preliminary model - a fact which shows that the selected model is a better fit. 

Selected Linear Model: 

Profitability Ratio = `r tidy(selected_m_pratio)[1,2]` + `r tidy(selected_m_pratio)[2,2]`(Holiday Release) + `r tidy(selected_m_pratio)[3,2]`(Likely Sequel) + `r tidy(selected_m_pratio)[4,2]`(Budget) + `r tidy(selected_m_pratio)[5,2]`(Major Production Company) + `r tidy(selected_m_pratio)[6,2]`(Spoken Language English) + `r tidy(selected_m_pratio)[7,2]`(Runtime) + `r tidy(selected_m_pratio)[8,2]`(Action) + `r tidy(selected_m_pratio)[9,2]`(Horror) + `r tidy(m_pratio)[10,2]`(Budget * Major Production Company) + `r tidy(m_pratio)[11,2]`(Likely Sequel * Budget)

We interpret a few terms of this model:

If a film is produced by a major production company, all else held constant, its expected pratio will increase by about 0.22.

For every increase of 1 in budget, all else held constant, we expect a decrease of about 6.47e-8 in expected pratio. This may seem extremely small, but the median budget for the dataset is 27 million dollars, which, multiplied by 6.47e-8, leads to an expected decrease of about 1.75 in pratio.

If a movie is a holiday release (all else held constant), its expected pratio will decrease by about 0.92.

Below is a comparison of the preliminary model's AIC compared to the selected model's AIC. Note that the lower value accompanies the selected model.

```{r aic-model-comparison}
glance(m_pratio)$AIC
glance(selected_m_pratio)$AIC
```



```{r rsq-selected-model}
newrsq <- glance(selected_m_pratio)$r.squared
newrsq
```

Our R-squared value of `r newrsq` for our final selected model indicates that `r newrsq *100`% of the variation in profitability ratio can be well-explained by a linear relationship with the selected variables (holiday release, likely sequel, budget, major production company, English spoken language, runtime, action genre, horror genre, budget/major production interaction, and budget/likely sequel interaction).

### Budget's Relationship to Revenue

As a final visualization and analysis, we looked at the relationship between budget and revenue. We created a single variable linear regression with budget as the explanatory variable, which led to an equation based on the values below.

```{r budget-revenue-model}
m_revenue <- lm(revenue ~ budget, data = movies)

tidy(m_revenue) %>%
  select(term, estimate)

rsq_mrevenue <- glance(m_revenue)$r.squared
```

Linear Model: Revenue = 143491 + 2.98(Budget)

We interpret the budget coefficient to mean that for every increase of \$1 in budget, there will be an increase of about \$2.98 in expected revenue. The intercept of this model indicates that for a film with a budget of zero dollars, we expect a revenue of about 143,491. However, we filtered out all of the points in our data set with budgets of zero and so this value is not likely an accurate interpretation.

The above equation nets an R-Squared value of `r rsq_mrevenue`, implying that approximately 49.73% of the linear variation in revenue can be well-explained by a linear relationship with budget. 

```{r visualize-revenue-model}
ggplot(data = movies, aes(x = budget, y = revenue, color = if_major)) +
  geom_jitter(alpha = .3) +
  stat_smooth(method = "lm", se = FALSE) +
  labs(title = "Budget vs. Revenue", subtitle = "For Major and Non-Major Production Companies")
```

In this final visualization, we have colored data points by whether they were created by a major production company or not. Note that the slope of the major companies’ regression line is steeper, meaning that our linear models predict a higher expected revenue for a major company's film than a non-major company's film with the same budget. The major company data points tend to be placed further to the upper right due to the greater resources of larger companies. All of the highest budgeted movies were created by major companies.

### Conclusion

Our final R-Squared value of only around .04 is dissapointing predictive power on the part of our selected linear model, but there are a few issues with our analysis that we believe may be lowering this value. Firstly, the dataset has a few key issues. 

There are data entry errors and inconsistencies. Specifically, as we have discussed prior, certain budgets are underestimated by six orders of magnitude. These irregular data points can wreak havoc on any sort of linear relationship between budget and other variables. While we've removed the most egregious offenders, there may still be examples of budgets underestimated by 3 or less orders of magnitude that can lower our R-Squared value.

The other broad category of data error is the currency issue noted previously. Again, while filtering for English as the original language is helpful in this regard, some of the entries still possess non-USD entries for budget and revenue. Since the data does not include units, there is no absolutely effective method of discriminating for the type of currency used other than manually checking all 5000 movies.

Inflation may also play a part in our strange findings; some values have been adjusted for inflation while others have not. Furthermore, the inflation adjustments might be made using different "base years" for certain observations. Consequently, the linear relationship can be comfounded and muddled by the effects of inflation on the data.

Even with a fairly low R-Squared value, we can still draw some interesting conclusions about the data and apply our findings to the real world. Firstly, budget is not an exclusive gatekeeper to a successful film; any combination of enough of the other preferential traits we have analyzed can create success, even in spite of a low budget. We see this truth as well as its contrafactual with a simple glance at two films: Pirates of the Caribbean: On Stranger Tides and Paranormal Activity. The former failed under the influence of the highest budget while the latter is the most profitable movie of all time by percentage with a budget less than $100,000. 

With specific reference to our investigation question of what factors make a movie profitable, we have seen firsthand the difficulty of predicting the success of a movie; this isn't surprising when one considers that there are still movies being made today that consider all of the above variables, but still fail. The variables we have selected play a small, but important role in a movie's success. Even with an R-Squared value of only .04 and consequent well-explained linear relationship, a 4% difference in pratio can account for millions or tens of millions of dollars. The most valuable information that we have found may not come in the form of what companies need to focus on, but rather the factors on which they should avoid wasting resources - taglines, for example. As we've seen with the horror genre, every reduction of cost - cutting out unncecessary factors - increases the potential for very high profitability ratios.

